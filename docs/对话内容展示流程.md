# 小智项目对话内容展示流程分析

## 1. 整体流程概述

小智项目的对话内容展示流程主要包括以下几个步骤：
1. 用户发起语音对话请求
2. 语音识别转换为文字
3. 文字内容通过WebSocket传输
4. 接收服务端返回的文字回复
5. 文字转语音播放
6. 对话内容在界面中展示

## 2. 核心组件

### 2.1 ChatBloc (业务逻辑层)
ChatBloc是整个对话流程的核心控制器，负责处理以下任务：
- 管理WebSocket连接
- 处理音频录制和播放
- 管理消息状态和历史记录
- 处理权限检查

### 2.2 ChatPage (UI层)
ChatPage是用户界面，负责：
- 显示对话历史记录
- 提供语音输入按钮
- 展示Live2D角色动画
- 响应用户交互

### 2.3 StorageUtil (数据存储层)
StorageUtil负责：
- 消息的本地数据库存储
- 分页查询历史消息

## 3. 详细流程

### 3.1 初始化阶段
1. ChatPage初始化时通过BlocProvider获取ChatBloc实例
2. ChatBloc在ChatInitialEvent中：
   - 建立WebSocket连接
   - 初始化音频录制和播放设备
   - 从本地数据库加载历史消息

### 3.2 发送语音消息
1. 用户长按"按住说话"按钮触发onLongPressStart事件
2. ChatPage调用ChatStartListenEvent事件
3. ChatBloc开始音频录制并通过WebSocket发送PCM音频数据
4. 服务端返回语音识别结果，通过ChatOnMessageEvent事件处理
5. 消息存入本地数据库并在UI中展示

### 3.3 接收回复消息
1. 服务端通过WebSocket发送文字回复消息
2. ChatBloc接收消息并触发ChatOnMessageEvent事件
3. 消息存入本地数据库并在UI中展示
4. 同时触发音频播放流程

### 3.4 消息展示
1. ChatPage通过BlocConsumer监听ChatBloc状态变化
2. 当ChatInitialState状态更新时，刷新消息列表
3. 使用ListView(reverse: true)反向展示消息，最新的消息在底部
4. 根据消息的sendByMe字段区分左右对齐方向
5. 用户消息右对齐，服务端回复左对齐

### 3.5 历史消息加载
1. 用户上拉刷新触发ChatLoadMoreEvent事件
2. ChatBloc从本地数据库分页查询历史消息
3. 更新ChatInitialState状态，合并新旧消息列表

## 4. 数据流向

```
用户操作 → ChatPage → ChatBloc → WebSocket → 服务端
                                       ↓
服务端响应 → WebSocket → ChatBloc → StorageUtil → ChatPage
                                       ↓
                             SQLite数据库 ← StorageUtil
```

## 5. UI展示细节

### 5.1 消息气泡样式
- 用户发送的消息使用primaryContainer颜色作为背景
- 服务端回复的消息使用tertiaryContainer颜色作为背景
- 消息宽度最大不超过屏幕宽度的75%

### 5.2 消息列表特性
- 使用SmartRefresher实现上拉加载更多
- 消息列表倒序排列，最新消息在底部
- 支持分页加载历史消息

### 5.3 Live2D动画集成
- 用户说话时触发Live2D角色的"speak"动作
- 接收回复时触发角色的"happy"表情
- 按钮按下时触发角色的"surprise"表情

## 6. 异常处理

### 6.1 权限处理
- 首次使用时检查麦克风权限
- 权限不足时弹窗提示用户授权

### 6.2 网络异常处理
- WebSocket断开连接时会尝试重新建立连接
- 连接错误时会在日志中打印错误信息

## 7. 性能优化

### 7.1 分页加载
- 历史消息采用分页加载，每页20条记录
- 减少内存占用和界面渲染压力

### 7.2 消息缓存
- 当前会话消息保存在内存中
- 历史消息存储在SQLite数据库中

## 8. 扩展性考虑

### 8.1 多媒体支持
- 当前主要支持文本消息，未来可扩展支持图片、语音等多媒体消息

### 8.2 多设备同步
- 通过WebSocket连接可以轻松扩展到多设备同步场景